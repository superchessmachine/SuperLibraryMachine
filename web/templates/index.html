<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SuperLibraryMachine RAG</title>
  <style>
    :root {
      --bg-color: #121212;
      --text-color: #e0e0e0;
      --accent-color: #4dabf7;
      --card-bg: #1e1e1e;
      --border-color: #2c2c2c;
      --input-bg: #2a2a2a;
    }

    body.light {
      --bg-color: #f5f5f5;
      --text-color: #222;
      --accent-color: #005f99;
      --card-bg: #fff;
      --border-color: #ccc;
      --input-bg: #fff;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 1rem;
      text-align: center;
      background: var(--card-bg);
      border-bottom: 1px solid var(--border-color);
      position: relative;
    }

    h1 {
      margin: 0;
      font-size: 1.8rem;
      color: var(--accent-color);
    }

    #toggle-theme, #clear-history {
      position: absolute;
      top: 1rem;
      padding: 0.3rem 0.8rem;
      border: 1px solid var(--accent-color);
      color: var(--accent-color);
      background: none;
      border-radius: 6px;
      cursor: pointer;
    }

    #toggle-theme { right: 1rem; }
    #clear-history { left: 1rem; }

    #chat-log {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .chat-box {
      max-width: 900px;
      width: 100%;
      margin: 0 auto;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1rem;
      white-space: pre-wrap;
    }

    .chat-box.user { border-left: 5px solid var(--accent-color); }
    .chat-box.assistant { border-left: 5px solid #8bc34a; }

    .chat-box.citations {
      font-size: 0.9rem;
      color: var(--accent-color);
    }

    .chat-box.citations a {
      color: var(--accent-color);
      text-decoration: none;
    }

    .chat-box.citations a:hover {
      text-decoration: underline;
    }

    footer {
      border-top: 1px solid var(--border-color);
      padding: 1rem;
      background-color: var(--card-bg);
    }

    form {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    select, input[type="text"] {
      padding: 0.5rem;
      background-color: var(--input-bg);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      border-radius: 6px;
      font-size: 1rem;
    }

    select {
      width: 200px;
    }

    input[type="text"] {
      flex: 1;
    }

    button[type="submit"] {
      padding: 0.6rem 1.2rem;
      font-size: 1rem;
      border: none;
      border-radius: 6px;
      background-color: var(--accent-color);
      color: #000;
      cursor: pointer;
    }

    #spinner {
      display: none;
      font-weight: bold;
      align-items: center;
      gap: 0.5rem;
    }

    .spinner-icon {
      border: 4px solid #444;
      border-top: 4px solid var(--accent-color);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <header>
    <h1>SuperLibraryMachine RAG</h1>
    <button id="toggle-theme">Toggle Theme</button>
    <button id="clear-history">Clear History</button>
  </header>

  <div id="chat-log"></div>

  <footer>
    <form method="POST" onsubmit="handleSubmit(event)">
      <select name="db" required {% if not databases %}disabled{% endif %}>
        {% if databases %}
          {% for db in databases %}
            <option value="{{ db }}" {% if db == selected_db %}selected{% endif %}>{{ db }}</option>
          {% endfor %}
        {% else %}
          <option value="">No databases available</option>
        {% endif %}
      </select>

      <input type="text" name="query" placeholder="Your question..." required {% if not databases %}disabled{% endif %}>
      <button type="submit" id="submit-button" {% if not databases %}disabled{% endif %}>Ask</button>
      <div id="spinner"><span class="spinner-icon"></span> Processingâ€¦</div>
    </form>
  </footer>

  <script>
    const form = document.querySelector("form");
    const input = form.querySelector('input[name="query"]');
    const spinner = document.getElementById("spinner");
    const submitBtn = document.getElementById("submit-button");
    const hasDatabases = {{ (databases|length > 0)|lower }};
    const dbRoot = {{ db_root|tojson }};

    function handleSubmit(e) {
      spinner.style.display = "flex";
      submitBtn.style.display = "none";
      localStorage.setItem("lastQuery", input.value);
    }

    document.getElementById("clear-history").onclick = () => {
      localStorage.removeItem("chatHistory");
      location.reload();
    };

    document.getElementById("toggle-theme").onclick = () => {
      document.body.classList.toggle("light");
    };

    document.addEventListener("DOMContentLoaded", () => {
      const log = document.getElementById("chat-log");
      const raw = `{{ answer | e }}`;
      const query = localStorage.getItem("lastQuery") || "";
      const citeBox = `{% if citations %}<div class='chat-box citations'><strong>Citations:</strong><ul>{% for num, doi in citations|dictsort(true) %}<li>[{{ num }}]: {% if doi != "N/A" %}<a href="https://pubmed.ncbi.nlm.nih.gov/?term={{ doi | urlencode }}&sort=pubdate&size=200" target="_blank">{{ doi }}</a>{% else %}DOI not available{% endif %}</li>{% endfor %}</ul></div>{% endif %}`;
      const history = JSON.parse(localStorage.getItem("chatHistory") || "[]");

      if (raw.trim()) {
        const cleaned = raw
          .replace(/^(\s*\*\s*(&nbsp;)?\s*)$/gm, '')
          .replace(/^[ \t]*\*\s+/gm, '')
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\n{2,}/g, '<br><br>')
          .replace(/\n/g, ' ');

        history.push({ q: query, a: cleaned, c: citeBox });
        localStorage.setItem("chatHistory", JSON.stringify(history));
        localStorage.removeItem("lastQuery");
      }

      log.innerHTML = "";

      if (!hasDatabases && history.length === 0) {
        const notice = document.createElement("div");
        notice.className = "chat-box assistant";
        notice.style.borderLeftColor = "#f39c12";
        notice.innerHTML = `<strong>No databases detected.</strong><br>Place a processed RAG database inside <code>${dbRoot}</code> so the assistant can answer questions.`;
        log.appendChild(notice);
      }

      history.forEach(entry => {
        const uq = document.createElement("div");
        uq.className = "chat-box user";
        uq.innerHTML = "<strong>You asked:</strong><br>" + entry.q;

        const ua = document.createElement("div");
        ua.className = "chat-box assistant";
        ua.innerHTML = "<strong>Assistant:</strong><br>" + entry.a;

        const uc = document.createElement("div");
        uc.className = "chat-box citations";
        uc.innerHTML = entry.c;

        log.appendChild(uq);
        log.appendChild(ua);
        log.appendChild(uc);
      });

      log.scrollTop = log.scrollHeight;
    });

    // Submit with Enter
    input.addEventListener("keypress", function (e) {
      if (e.key === "Enter") {
        e.preventDefault();
        form.requestSubmit();
      }
    });
  </script>
</body>
</html>
